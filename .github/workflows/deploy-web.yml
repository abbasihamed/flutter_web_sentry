name: Build & Deploy (Docker) + Sentry CLI

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

env:
  SENTRY_ENV: production
  # Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶Ø› Ø¯Ø± Ù‚Ø¯Ù… Ø¨Ø¹Ø¯ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯
  BASE_HREF: "/flutter_web_sentry/"

jobs:
  build-pages:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1) BASE_HREF Ø±Ø§ Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ø² Ù†Ø§Ù… Ø±ÛŒÙ¾Ùˆ Ø¨Ø³Ø§Ø² (OWNER.github.io => / ; Ù¾Ø±ÙˆÚ˜Ù‡â€ŒØ§ÛŒ => /<repo>/)
      - name: Compute BASE_HREF
        run: |
          REPO="${{ github.event.repository.name }}"
          OWNER="${{ github.repository_owner }}"
          if [ "$REPO" = "${OWNER}.github.io" ]; then
            echo "BASE_HREF=/" >> $GITHUB_ENV
          else
            echo "BASE_HREF=/$REPO/" >> $GITHUB_ENV
          fi
          echo "BASE_HREF=$(grep BASE_HREF $GITHUB_ENV | cut -d= -f2)"

      # 2) Release Ùˆ DistDir Ø±Ø§ Ù‡Ù…ÛŒÙ†â€ŒØ¬Ø§ ØªÙˆÙ„ÛŒØ¯ Ú©Ù†
      - name: Compute release & dist
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          TS="$(date -u +%Y%m%d-%H%M%S)"
          echo "SENTRY_RELEASE=web-${SHORT_SHA}-${TS}" >> $GITHUB_ENV
          echo "DIST_DIR=dist-${SHORT_SHA}" >> $GITHUB_ENV
          echo "SENTRY_RELEASE=$(grep SENTRY_RELEASE $GITHUB_ENV | cut -d= -f2)"
          echo "DIST_DIR=$(grep DIST_DIR $GITHUB_ENV | cut -d= -f2)"

      # 3) DSN Ø±Ø§ Ø§Ø² Secrets/Vars Ø­Ù„ Ú©Ù† (fallback Ù…Ø·Ù…Ø¦Ù†)
      - name: Resolve SENTRY_DSN
        run: |
          if [ -n "${{ secrets.SENTRY_DSN }}" ]; then
            echo "SENTRY_DSN=${{ secrets.SENTRY_DSN }}" >> $GITHUB_ENV
          elif [ -n "${{ vars.SENTRY_DSN }}" ]; then
            echo "SENTRY_DSN=${{ vars.SENTRY_DSN }}" >> $GITHUB_ENV
          else
            echo "::error::SENTRY_DSN is not set (secret or variable)"; exit 1
          fi

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 4) Ø¨ÛŒÙ„Ø¯ Ø§Ø³ØªÛŒØ¬ artifact Ùˆ Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¯Ø± DIST_DIR
      - name: Build artifact with Docker and export files
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          target: artifact
          push: false
          build-args: |
            FLUTTER_VERSION=stable
            BASE_HREF=${{ env.BASE_HREF }}
            SENTRY_DSN=${{ env.SENTRY_DSN }}
            SENTRY_ENV=${{ env.SENTRY_ENV }}
            SENTRY_RELEASE=${{ env.SENTRY_RELEASE }}
          outputs: type=local,dest=${{ env.DIST_DIR }}

      # 5) SPA fix: 404.html = index.html
      - name: Add 404.html for SPA
        run: cp "${{ env.DIST_DIR }}/index.html" "${{ env.DIST_DIR }}/404.html"

      # 6) sanity check: ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ ÙˆØ§Ù‚Ø¹Ø§Ù‹ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù†Ø¯ØŸ
      - name: Sanity check built files
        run: |
          ls -la "${DIST_DIR}"
          test -f "${DIST_DIR}/index.html"
          test -f "${DIST_DIR}/flutter_bootstrap.js"
          # Ø§Ú¯Ø± manifest.json Ù†Ø¯Ø§Ø±ÛŒ Ø§ÛŒÙ† Ø®Ø· fail Ù…ÛŒâ€ŒÚ©Ù†Ø¯Ø› Ø¯Ø± Ø§ÛŒÙ† ØµÙˆØ±Øª ÙØ§ÛŒÙ„ web/manifest.json Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
          test -f "${DIST_DIR}/manifest.json"

      # 7) Ù†ØµØ¨ sentry-cli
      - name: Install sentry-cli
        run: |
          curl -sL https://sentry.io/get-cli/ | bash
          echo "$HOME/.sentrycli/bin" >> $GITHUB_PATH

      # 8) Ø¯ÛŒØ¨Ø§Ú¯ Ø§ØªØµØ§Ù„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ ÙˆÙ„ÛŒ Ù…ÙÛŒØ¯)
      - name: Verify Sentry auth (debug)
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG:        ${{ secrets.SENTRY_ORG }}
        run: sentry-cli info

      # 9) Ø³Ø§Ø®Øª ReleaseØŒ Ø¢Ù¾Ù„ÙˆØ¯ Ø³ÙˆØ±Ø³â€ŒÙ…Ù¾ØŒ finalize Ùˆ Ø«Ø¨Øª deploy
      - name: Create release, upload sourcemaps, finalize & deploy
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG:        ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT:    ${{ secrets.SENTRY_PROJECT }}
        run: |
          echo "ğŸ”§ Release=${SENTRY_RELEASE}  Env=${SENTRY_ENV}  BASE_HREF=${BASE_HREF}  DIR=${DIST_DIR}"

          # Ø³Ø§Ø®Øª Ø±ÛŒÙ„ÛŒØ² Ùˆ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡
          sentry-cli releases new -p "$SENTRY_PROJECT" "$SENTRY_RELEASE"

          # (Ø§Ø®ØªÛŒØ§Ø±ÛŒ) Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú©Ø§Ù…ÛŒØªâ€ŒÙ‡Ø§
          # sentry-cli releases set-commits "$SENTRY_RELEASE" --auto

          # Ø¢Ù¾Ù„ÙˆØ¯ sourcemaps Ø¨Ø§ url-prefix Ù…Ø·Ø§Ø¨Ù‚ base-href
          sentry-cli sourcemaps upload \
            --org "$SENTRY_ORG" \
            --project "$SENTRY_PROJECT" \
            --release "$SENTRY_RELEASE" \
            --url-prefix "~${BASE_HREF}" \
            --rewrite \
            --validate \
            "${DIST_DIR}"

          # finalize Ùˆ Ø«Ø¨Øª deploy
          sentry-cli releases finalize "$SENTRY_RELEASE"
          sentry-cli releases deploys "$SENTRY_RELEASE" new -e "$SENTRY_ENV"

      # 10) Ø¢Ù¾Ù„ÙˆØ¯ Ø¨Ø±Ø§ÛŒ Pages
      - name: Upload artifact to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.DIST_DIR }}

  deploy:
    runs-on: ubuntu-latest
    needs: build-pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
