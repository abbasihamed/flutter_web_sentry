name: Build & Deploy (Docker) + Sentry CLI

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

env:
  SENTRY_ENV: production

jobs:
  build-pages:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # BASE_HREF Ø±Ø§ Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ø² Ù†Ø§Ù… Ø±ÛŒÙ¾Ùˆ Ø¨Ø³Ø§Ø²
      - name: Compute BASE_HREF
        run: |
          REPO="${{ github.event.repository.name }}"
          OWNER="${{ github.repository_owner }}"
          if [ "$REPO" = "${OWNER}.github.io" ]; then
            echo "BASE_HREF=/" >> $GITHUB_ENV
          else
            echo "BASE_HREF=/$REPO/" >> $GITHUB_ENV
          fi
          echo "BASE_HREF=$(cat $GITHUB_ENV | grep BASE_HREF | cut -d= -f2)"

      # Release Ùˆ DistDir Ø±Ø§ Ù‡Ù…ÛŒÙ†â€ŒØ¬Ø§ ØªÙˆÙ„ÛŒØ¯ Ú©Ù† (Ø¨Ø¯ÙˆÙ† Ø§ØªÚ©Ø§ Ø¨Ù‡ ENV ÙˆØ±ÙˆØ¯ÛŒ)
      - name: Compute release & dist
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          TS="$(date -u +%Y%m%d-%H%M%S)"
          echo "SENTRY_RELEASE=web-${SHORT_SHA}-${TS}" >> $GITHUB_ENV
          echo "DIST_DIR=dist-${SHORT_SHA}" >> $GITHUB_ENV
          echo "SENTRY_RELEASE=$(cat $GITHUB_ENV | grep SENTRY_RELEASE | cut -d= -f2)"
          echo "DIST_DIR=$(cat $GITHUB_ENV | grep DIST_DIR | cut -d= -f2)"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Ø¨ÛŒÙ„Ø¯ Ø§Ø³ØªÛŒØ¬ artifact Ùˆ Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¯Ø± DIST_DIR (ØªÙˆÙ„ÛŒØ¯Ø´Ø¯Ù‡)
      - name: Build artifact with Docker and export files
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          target: artifact
          push: false
          build-args: |
            FLUTTER_VERSION=stable
            BASE_HREF=${{ env.BASE_HREF }}
            SENTRY_DSN=${{ secrets.SENTRY_DSN || vars.SENTRY_DSN }}
            SENTRY_ENV=${{ env.SENTRY_ENV }}
            SENTRY_RELEASE=${{ env.SENTRY_RELEASE }}
          outputs: type=local,dest=${{ env.DIST_DIR }}

      # # SPA fix
      # - name: Add 404.html for SPA
      #   run: cp "${{ env.DIST_DIR }}/index.html" "${{ env.DIST_DIR }}/404.html"

      # Install sentry-cli
      - name: Install sentry-cli
        run: |
          curl -sL https://sentry.io/get-cli/ | bash
          echo "$HOME/.sentrycli/bin" >> $GITHUB_PATH

      # Upload sourcemaps via sentry-cli (Release Ø§Ø² Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡)
      - name: Upload sourcemaps to Sentry
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG:        ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT:    ${{ secrets.SENTRY_PROJECT }}
        run: |
          echo "ðŸ”§ Release=${SENTRY_RELEASE}, Env=${SENTRY_ENV}, BASE_HREF=${BASE_HREF}, DIR=${DIST_DIR}"
          # Ø§Ú¯Ø± Ø±ÛŒÙ¾Ùˆ Ø¨Ù‡ Sentry Ù…ØªØµÙ„ Ø§Ø³Øª Ù…ÛŒâ€ŒØªÙˆØ§Ù† set-commits Ø±Ø§ Ù‡Ù… Ø§Ù†Ø¬Ø§Ù… Ø¯Ø§Ø¯:
          # sentry-cli releases new -p "$SENTRY_PROJECT" "$SENTRY_RELEASE"
          # sentry-cli releases set-commits "$SENTRY_RELEASE" --auto

          sentry-cli sourcemaps upload \
            --org "$SENTRY_ORG" \
            --project "$SENTRY_PROJECT" \
            --release "$SENTRY_RELEASE" \
            --url-prefix "~${BASE_HREF}" \
            --rewrite \
            --validate \
            "${DIST_DIR}"

          sentry-cli releases finalize "$SENTRY_RELEASE"
          sentry-cli releases deploys "$SENTRY_RELEASE" new -e "$SENTRY_ENV"

      - name: Upload artifact to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.DIST_DIR }}

  deploy:
    runs-on: ubuntu-latest
    needs: build-pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
